(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
module.exports = (function(){
  var floor = Math.floor;
  function rectangle(x, y, w, h, c){
    x = floor(x);
    y = floor(y);
    return function(W, H, col){
      for (var j=-h; j<=h; ++j)
        for (var i=-w; i<=w; ++i)
          if (0<=(x+i) && (x+i)<W && 0<=(y+j) && (y+j)<H)
            col[(y+j)*W+(x+i)] = c;
      return col;
    };
  };
  return {rectangle: rectangle};
})();

},{}],2:[function(require,module,exports){
module.exports = (function(){
  var Drawers = require("./Drawers.js");

  var abs = Math.abs;
  var floor = Math.floor;
  var sqrt = Math.sqrt;

  function Hitbox(id, dim, pos, vel, fall){
    return {
      id:id,
      dim:dim,
      pos:pos,
      vel:vel,
      fall: fall};
  };

  function drawer(hitbox, c){
    return Drawers.rectangle(hitbox.pos.x, hitbox.pos.y, hitbox.dim.x, hitbox.dim.y, c);
  };

  function tick(dt, space, spaceWidth, spaceHeight, box){
    var w  = box.dim.x, h  = box.dim.y;
    var x  = box.pos.x, y  = box.pos.y;
    var vx = box.vel.x, vy = box.vel.y;
    var sw = spaceWidth;
    var id = box.id;

    // Integrate velocity
    vy += dt * box.fall;

    // Remove from space
    for (var px=-w; px<w; ++px)
      space[(floor(y)-h) * sw + (floor(x)+px)] = 0,
      space[(floor(y)+h) * sw + (floor(x)+px)] = 0;
    for (var py=-h; py<h; ++py)
      space[(floor(y)+py) * sw + (floor(x)-w)] = 0,
      space[(floor(y)+py) * sw + (floor(x)+w)] = 0;

    // Integrate position
    var collisions = {};
    for (var k=0; k<=1; ++k){
      for (var t=0, ts=Math.abs((k?vx:vy)*dt); t<ts; ++t){
        var spd = Math.min(ts - t, 1) * Math.sign(k?vx:vy);
        if (k) x += spd;
        else   y += spd;
        for (var m=0; m<=1; ++m){
          for (var p=(m?-w:-h); p<(m?w:h); ++p){
            if ( space[(floor(y)+(m?-h:p))*sw + (floor(x)+(m?p:-w))]
              || space[(floor(y)+(m? h:p))*sw + (floor(x)+(m?p: w))]){
              collisions[space[(floor(y)+(m?-h:p))*sw + (floor(x)+(m?p:-w))]] = true;
              collisions[space[(floor(y)+(m? h:p))*sw + (floor(x)+(m?p: w))]] = true;
              if (k) x -= spd, vx = 0;
              else   y -= spd, vy = 0;
            };
          };
        };
      };
    };

    // Add to space
    for (var px=-w; px<w; ++px)
      space[(floor(y)-h) * sw + (floor(x)+px)] = id,
      space[(floor(y)+h) * sw + (floor(x)+px)] = id;
    for (var py=-h; py<h; ++py)
      space[(floor(y)+py) * sw + (floor(x)-w)] = id,
      space[(floor(y)+py) * sw + (floor(x)+w)] = id;

    // Save
    box.pos.x = x;
    box.pos.y = y;
    box.vel.x = vx;
    box.vel.y = vy;

    // Returns collisions
    delete collisions[0];
    return collisions;
  };

  function destroy(box, space, spaceWidth, spaceHeight){
    var w  = box.dim.x, h  = box.dim.y;
    var x  = box.pos.x, y  = box.pos.y;
    var vx = box.vel.x, vy = box.vel.y;
    var sw = spaceWidth;
    // Remove from space
    for (var px=-w; px<w; ++px)
      space[(floor(y)-h) * sw + (floor(x)+px)] = 0,
      space[(floor(y)+h) * sw + (floor(x)+px)] = 0;
    for (var py=-h; py<h; ++py)
      space[(floor(y)+py) * sw + (floor(x)-w)] = 0,
      space[(floor(y)+py) * sw + (floor(x)+w)] = 0;
  };


  // *Hitbox, Hitbox -> Hitbox
  //function slide(a, b){
    //var ax = a.pos.x, ay = a.pos.y, aw = a.dim.x, ah = a.dim.y;
    //var bx = b.pos.x, by = b.pos.y, bw = b.dim.x, bh = b.dim.y;
    //var avx = a.vel.x, avy = a.vel.y;
    //var axi = ax - aw*0.5, axf = ax + aw*0.5;
    //var ayi = ay - ah*0.5, ayf = ay + ah*0.5;
    //var bxi = bx - bw*0.5, bxf = bx + bw*0.5;
    //var byi = by - bh*0.5, byf = by + bh*0.5;
    //var dx = abs(bx - ax) - (aw*0.5 + bw*0.5);
    //var dy = abs(by - ay) - (ah*0.5 + bh*0.5);

    //console.log("a:", ax, ay, aw, ah);
    //console.log("b:", bx, by, bw, bh);
    //console.log("av:", avx, avy);
    //console.log("axr:",axi, axf, "ayr:",ayi, ayf);
    //console.log("bxr:",bxi, bxf, "byr:",byi, byf);
    //console.log("d:",dx,dy);

    //if (bx >= 0 || dy >= 0)
      //return a;

    //if (dx > dy) {
      //if (bxi < axi && axi < bxf && avx <= 0) {
        //a.pos.x += bxf - axi;
        //a.vel.x = 0;
      //}
      //if (bxi < axf && axf < bxf && avx >= 0) {
        //a.pos.x += bxi - axf;
        //a.vel.x = 0;
      //}
    //} else  {
      //if (byi < ayi && ayi < byf && avy <= 0){
        //a.pos.y -= dy;
        //a.vel.y = 0;
      //}
      //if (byi < ayi && ayi < byf && avy >= 0){
        //a.pos.y += dy;
        //a.vel.y = 0;
      //}
    //};

    //return a;
  //};

  return {
    Hitbox: Hitbox,
    drawer: drawer,
    destroy: destroy,
    tick: tick};
})();

},{"./Drawers.js":1}],3:[function(require,module,exports){
module.exports = (function(){
  var down = [], last = [], pressed = [], released = [];
  for (var i=0; i<255; ++i){
    var k = String.fromCharCode(i);
    down[k] = last[k] = pressed[k] = released[k] = 0;
  };
  document.onkeypress = function(e){
    down[String.fromCharCode(e.keyCode).toLowerCase()] = 1;
  };
  document.onkeyup = function(e){
    down[String.fromCharCode(e.keyCode).toLowerCase()] = 0;
  };
  function tick(){
    for (var i=0; i<255; ++i){
      var k = String.fromCharCode(i);
      pressed[k]  = !last[k] &&  down[k];
      released[k] =  last[k] && !down[k];
      last[k]     = down[k];
    };
  };
  return {down: down, pressed: pressed, released: released, tick: tick};
});

},{}],4:[function(require,module,exports){
module.exports = (function(){
  // Uint, Uint -> Screen
  function Screen(width, height){
    var canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    var context = canvas.getContext("2d");
    var imageData = context.getImageData(0, 0, width, height);
    var colorBuffer = new ArrayBuffer(width*height*4);
    var colorBuffer8 = new Uint8ClampedArray(colorBuffer);
    var colorBuffer32 = new Uint32Array(colorBuffer);
    var depthBuffer = new ArrayBuffer(width*height*2);
    var depthBuffer16 = new Uint16Array(depthBuffer);
    return {
      canvas: canvas,
      context: context,
      width: width,
      height: height,
      imageData: imageData,
      colorBuffer8: colorBuffer8,
      colorBuffer32: colorBuffer32,
      depthBuffer16: depthBuffer16};
  };

  // Uint32Array, *Screen -> Screen
  function drawBuffer(buffer8, screen){
    screen.imageData.data.set(buffer8);
    screen.context.putImageData(screen.imageData, 0, 0);
  };

  // [(Number, Number, *Uint32Array -> Uint32Array)] -> *Screen -> Screen
  function drawDrawers(drawers, screen){
    var colorBuffer32 = screen.colorBuffer32;
    for (var i=0, l=drawers.length; i<l; ++i)
      colorBuffer32 = drawers[i](screen.width, screen.height, colorBuffer32);
    screen.imageData.data.set(screen.colorBuffer8);
    screen.context.putImageData(screen.imageData, 0, 0);
    return screen;
  };

  // (Uint, Uint -> RGBA8), *Screen -> Screen
  function draw(field, screen){
    var colorBuffer32 = screen.colorBuffer32;
    var width = screen.width;
    var height = screen.height;
    for (var y=0; y<height; ++y)
      for (var x=0; x<width; ++x)
        colorBuffer32[y*width+x] = field(x, y);
    screen.imageData.data.set(screen.colorBuffer8);
    screen.context.putImageData(screen.imageData, 0, 0);
    return screen;
  };

  function drawImage(x, y, image, screen){
    screen.context.drawImage(image, x, y);
  };

  // *Screen -> Screen
  function clear(screen, col){
    screen.colorBuffer32.fill(col);
  };

  return {
    Screen: Screen,
    drawBuffer: drawBuffer,
    drawDrawers: drawDrawers,
    drawImage: drawImage,
    draw: draw,
    clear: clear};
})();


},{}],5:[function(require,module,exports){
module.exports = function(callback){
  var sprites = {
    "wall": {size: 1, images:[]},
    "main_standing": {size: 2, images:[]}};
  var loaded = 0;
  var total = 0;
  for (var key in sprites){
    (function (key){
      console.log("loading sprite "+key);
      for (var i=0; i<sprites[key].size; ++i){
        (function(i){
          ++total;
          var image = new Image();
          image.src = "img/"+key+"/sprite_"+i+".png";
          image.onload = function(){
            console.log("loaded "+(loaded+1)+"/"+total);
            sprites[key].images[i] = image;
            if (++loaded === total)
              callback(sprites);
          };
        })(i);
      };
    })(key);
  };
};



},{}],6:[function(require,module,exports){
module.exports = [
  ["................................",
   ".XXX.XX..XXX.XX.................",
   ".X.X.X.X.X.X.X..................",
   ".XXX.XX..X.X.XX.................",
   ".X...X.X.X.X.X..................",
   ".X...X.X.XXX.X..................",
   "................................",
   "X..........................DXXXX",
   "X..........................DXXXX",
   "X.H........................DXXXX",
   "X..........XXXXXX..........DXXXX",
   "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"],
  ["................................",
   ".XXX.XX..XXX.XX.................",
   ".X.X.X.X.X.X.X..................",
   ".XXX.XX..X.X.XX.................",
   ".X...X.X.X.X.X..................",
   ".X...X.X.XXX.X..................",
   "...............K................",
   "X..........................DXXXX",
   "X..........................DXXXX",
   "X.H........................DXXXX",
   "X..........XXXXXX..........DXXXX",
   "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"]];

},{}],7:[function(require,module,exports){
module.exports = (function(){
  // Number, Number -> V2
  function Vector2(x, y){
    return {x: x, y: y};
  }
  
  // V2, V2 -> Number
  function angle(a, b){
    var ang = (Math.atan2(b.y, b.x) - Math.atan2(a.y, a.x) + Math.PI*2) % (Math.PI*2);
    if (ang > Math.PI) ang -= Math.PI*2;
    return ang;
  };

  // V2 -> Number
  function len(a){
    return Math.sqrt(a.x*a.x + a.y*a.y);
  };

  // V2, Number -> V2
  function scale(a, s){
    return Vector2(a.x * s, a.y * s);
  };

  // V2 -> Number
  function normalize(a){
    return scale(a, 1/len(a)); 
  };

  // V2, Number -> V2
  function rotate(a, ang){
    return {
      x: a.x * Math.cos(ang) - a.y * Math.sin(ang),
      y: a.x * Math.sin(ang) + a.y * Math.cos(ang)};
  };

  // V2, V2 -> V2
  function sub(a, b){
    return {
      x: a.x - b.x,
      y: a.y - b.y};
  };

  // V2, V2 -> V2
  function add(a, b){
    return {
      x: a.x + b.x,
      y: a.y + b.y};
  };

  return {
    Vector2: Vector2,
    rotate: rotate,
    angle: angle,
    add: add,
    sub: sub,
    len: len,
    scale: scale,
    normalize: normalize};
})();

},{}],8:[function(require,module,exports){
//var Image = require("./../../Dattata/Image.js");
var Screen = require("./Screen.js");
var Sprites = require("./Sprites.js");
var Hitbox = require("./Hitbox.js");
var Drawers = require("./Drawers.js");
var Vector2 = require("./Vector2.js");
var stages = require("./Stages.js");
var Key = require("./KeyboardState.js")();
var V2 = Vector2.Vector2;
var floor = Math.floor;
var sqrt = Math.sqrt;
var FPS = 60;
var sprites;
var screen = Screen.Screen(window.innerWidth, window.innerHeight);
var gameObjects;
var gameObjectById;
var hero;
var game;
var level;
var space;
var spaceWidth;
var spaceHeight;

var Neo = (function(){
  var nextId = 0;
  return function(w, h, x, y, fall){
    var id = ++nextId;
    var obj = {
      id: id,
      render: function(screen){},
      tick: function(dt){},
      destroy: function(){
        Hitbox.destroy(obj.hitbox, space, spaceWidth, spaceHeight);
        delete gameObjectById[obj.id];
        gameObjects = gameObjects.filter(function(obj_){
          return obj_.id !== obj.id;
        });
      },
      hitbox: Hitbox.Hitbox(id, V2(w, h), V2(x, y), V2(0, 0), fall)};
    gameObjects.push(obj);
    gameObjectById[obj.id] = obj;
    return obj;
  };
})();

var intro = Intro();
var menu = Menu();
var runningApp = intro;

function interact_with_human(kill_humans, be_nice_to_humans){
  var is_crazy_murdering_robot = false;
  if (is_crazy_murdering_robot = true)
    kill_humans();
  else
    be_nice_to_humans();
};

function Intro(){
  var selected = 0;
  var options = [0, 1, 2];
  var prev = {};
  function tick(dt){
    if (Key.pressed.w)
      selected = (selected - 1 + 3) % 3;
    if (Key.pressed.s)
      selected = (selected + 1 + 3) % 3;
    if (Key.pressed.j)
      StartLevel(0);
  };
  function render(screen){
    Screen.drawDrawers(options.map(function(i){
      var col = i === selected ? 0xFFAAAAAA : 0xFFCCCCCC;
      return Drawers.rectangle(32*5, 32*(1+i*2), 32*4, 16, col);
    }), screen);
  };
  return {tick: tick, render: render};
};

function KillerRobot(x, y){
  var obj = Neo(2, 2, x, y, 0);
  var charge = 0;
  obj.tick = function(dt){
    charge += dt;
    if (charge > 1){
      charge = 0;
      var dir = Vector2.sub(hero.hitbox.pos, obj.hitbox.pos);
      Laser(obj.hitbox.pos.x, obj.hitbox.pos.y, dir.x, dir.y);
    };
  };
  obj.draw = function(x, y){
    screen.context.drawImage(sprites.main_standing.images[0], x, y);
  };
  return obj;
};

function Laser(x, y, dx, dy){
  var d = Math.sqrt(dx*dx + dy*dy);
  var obj = Neo(3, 3, x+dx/d*16, y, 0);
  obj.type = "Laser";
  obj.hitbox.vel.x = dx/d*500;
  obj.hitbox.vel.y = dy/d*500;
  obj.draw = function(x, y){
    screen.context.drawImage(sprites.main_standing.images[0], x, y);
    //return Drawers.rectangle(x, y, obj.hitbox.dim.x, obj.hitbox.dim.y, 0xFFFFAAAA);
  };
  obj.onCollide = function(other){
    obj.destroy();
    if (other.type === "Hero")
      StartLevel(level);
      
  };
};

function Hero(x, y){
  var obj = Neo(16, 16, x, y, 400);
  var canJump = 1;
  obj.type = "Hero";
  obj.tick = function(dt){
    var pad = V2(Key.down.d - Key.down.a, Key.down.s - Key.down.w);
    obj.hitbox.vel.x = pad.x * 140;
    if (canJump && Key.pressed.j){
      obj.hitbox.vel.y = -220;
      canJump = 0;
    };
  };
  obj.draw = function(x, y){
    var i = Math.floor(((Date.now()/1000)*4)%2);
    screen.context.drawImage(sprites.main_standing.images[i], x, y);
  };
  obj.onCollide = function(obj){
    if (!obj) return; // TODO: FIXME
    if (obj.type === "Wall")
      canJump = 1;
    if (obj.type === "Door")
      StartLevel(level + 1);
  };
  return obj;
};

function Wall(x,y){
  var obj = Neo(16,16, x,y, 0);
  function tick(){};
  function draw(x, y){
    screen.context.drawImage(sprites.wall.images[0], x, y);
    //return Drawers.rectangle(x, y, obj.hitbox.dim.x, obj.hitbox.dim.y, 0xFFAAAAAA);
  };
  obj.type = "Wall";
  obj.tick = tick;
  obj.draw = draw;
  return obj;
};

function Door(x,y){
  var obj = Neo(16,16, x,y, 0);
  function tick(){};
  function draw(x, y){
    screen.context.drawImage(sprites.main_standing.images[0], x, y);
  };
  obj.type = "Door";
  obj.tick = tick;
  obj.draw = draw;
  return obj;
  
};

function Game(stage){
  var count = 0;
  gameObjects = [];
  gameObjectById = {};
  for (var j=0; j<stage.length; ++j){
    var line = stage[j];
    for (var i=0; i<line.length; ++i){
      switch (line[i]){
        case "H": hero = Hero(i*32-16, j*32-16); break;
        case "X": Wall(i*32-16, j*32-16); break;
        case "D": Door(i*32-16, j*32-16); break;
        case "K": KillerRobot(i*32-16, j*32-16); break;
      }
    };
  };

  function tick(dt){
    if (Key.pressed.m)
      runningApp = menu;
    for (var i=0, l=gameObjects.length; i<l; ++i){
      gameObjects[i].tick(dt);
      var collisions = Hitbox.tick(dt, space, spaceWidth, spaceHeight, gameObjects[i].hitbox);
      if (gameObjects[i].onCollide)
        for (var id in collisions){
          gameObjects[i].onCollide(gameObjectById[id]);
          if (gameObjectById[id].onCollide)
            gameObjectById[id].onCollide(gameObjectById[i]);
            
        }
    };
  };
  function render(screen){
    screen.context.clearRect(0, 0, screen.width, screen.height);
    for (var i=0; i<gameObjects.length; ++i){
      var obj = gameObjects[i];
      var pos = Vector2.add(
        Vector2.sub(obj.hitbox.pos, hero.hitbox.pos),
        V2(screen.width/2, screen.height/2));
      obj.draw(pos.x, pos.y);
    };
  };
  return {tick: tick, render: render};
};

function Menu(){
  function tick(dt){
    if (Key.pressed.j)
      runningApp = game;
  };
  function render(screen){
    Screen.drawDrawers([Drawers.rectangle(32, 32, 8, 8, 0xFFFFAAAA)], screen);
  };
  return {tick: tick, render: render};
};

function StartLevel(lv){
  console.log("?");
  setTimeout(function(){
    spaceWidth = 2048;
    spaceHeight = 2048;
    space = new Uint16Array(spaceWidth * spaceHeight);
    runningApp = game = Game(stages[lv%stages.length]);
    console.log("?", stages[lv%stages.length], lv, stages.length);
    level = lv;
  }, 1);
};

window.onload = function(){
  Sprites(function(sprites_){
    sprites = sprites_;
    var main = document.getElementById("main");
    screen.canvas.style = [
      "image-rendering: optimizeSpeed;",
      "image-rendering: -moz-crisp-edges;",
      "image-rendering: -webkit-optimize-contrast;",
      "image-rendering: -o-crisp-edges;",
      "image-rendering: pixelated;",
      "-ms-interpolation-mode: nearest-neighbor;"].join("");
    main.appendChild(screen.canvas);
    setInterval(function(){
      Key.tick();
      runningApp.tick(1/FPS);
      Screen.clear(screen);
      runningApp.render(screen);
    }, 1000/FPS);

    document.body.appendChild(sprites.main_standing.images[0]);
  });
};


},{"./Drawers.js":1,"./Hitbox.js":2,"./KeyboardState.js":3,"./Screen.js":4,"./Sprites.js":5,"./Stages.js":6,"./Vector2.js":7}]},{},[8])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Vzci9sb2NhbC9saWIvbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsInNyYy9EcmF3ZXJzLmpzIiwic3JjL0hpdGJveC5qcyIsInNyYy9LZXlib2FyZFN0YXRlLmpzIiwic3JjL1NjcmVlbi5qcyIsInNyYy9TcHJpdGVzLmpzIiwic3JjL1N0YWdlcy5qcyIsInNyYy9WZWN0b3IyLmpzIiwic3JjL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDZkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDaEpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDdEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN2RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDM0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDekJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKTt0aHJvdyBmLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwibW9kdWxlLmV4cG9ydHMgPSAoZnVuY3Rpb24oKXtcbiAgdmFyIGZsb29yID0gTWF0aC5mbG9vcjtcbiAgZnVuY3Rpb24gcmVjdGFuZ2xlKHgsIHksIHcsIGgsIGMpe1xuICAgIHggPSBmbG9vcih4KTtcbiAgICB5ID0gZmxvb3IoeSk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKFcsIEgsIGNvbCl7XG4gICAgICBmb3IgKHZhciBqPS1oOyBqPD1oOyArK2opXG4gICAgICAgIGZvciAodmFyIGk9LXc7IGk8PXc7ICsraSlcbiAgICAgICAgICBpZiAoMDw9KHgraSkgJiYgKHgraSk8VyAmJiAwPD0oeStqKSAmJiAoeStqKTxIKVxuICAgICAgICAgICAgY29sWyh5K2opKlcrKHgraSldID0gYztcbiAgICAgIHJldHVybiBjb2w7XG4gICAgfTtcbiAgfTtcbiAgcmV0dXJuIHtyZWN0YW5nbGU6IHJlY3RhbmdsZX07XG59KSgpO1xuIiwibW9kdWxlLmV4cG9ydHMgPSAoZnVuY3Rpb24oKXtcbiAgdmFyIERyYXdlcnMgPSByZXF1aXJlKFwiLi9EcmF3ZXJzLmpzXCIpO1xuXG4gIHZhciBhYnMgPSBNYXRoLmFicztcbiAgdmFyIGZsb29yID0gTWF0aC5mbG9vcjtcbiAgdmFyIHNxcnQgPSBNYXRoLnNxcnQ7XG5cbiAgZnVuY3Rpb24gSGl0Ym94KGlkLCBkaW0sIHBvcywgdmVsLCBmYWxsKXtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6aWQsXG4gICAgICBkaW06ZGltLFxuICAgICAgcG9zOnBvcyxcbiAgICAgIHZlbDp2ZWwsXG4gICAgICBmYWxsOiBmYWxsfTtcbiAgfTtcblxuICBmdW5jdGlvbiBkcmF3ZXIoaGl0Ym94LCBjKXtcbiAgICByZXR1cm4gRHJhd2Vycy5yZWN0YW5nbGUoaGl0Ym94LnBvcy54LCBoaXRib3gucG9zLnksIGhpdGJveC5kaW0ueCwgaGl0Ym94LmRpbS55LCBjKTtcbiAgfTtcblxuICBmdW5jdGlvbiB0aWNrKGR0LCBzcGFjZSwgc3BhY2VXaWR0aCwgc3BhY2VIZWlnaHQsIGJveCl7XG4gICAgdmFyIHcgID0gYm94LmRpbS54LCBoICA9IGJveC5kaW0ueTtcbiAgICB2YXIgeCAgPSBib3gucG9zLngsIHkgID0gYm94LnBvcy55O1xuICAgIHZhciB2eCA9IGJveC52ZWwueCwgdnkgPSBib3gudmVsLnk7XG4gICAgdmFyIHN3ID0gc3BhY2VXaWR0aDtcbiAgICB2YXIgaWQgPSBib3guaWQ7XG5cbiAgICAvLyBJbnRlZ3JhdGUgdmVsb2NpdHlcbiAgICB2eSArPSBkdCAqIGJveC5mYWxsO1xuXG4gICAgLy8gUmVtb3ZlIGZyb20gc3BhY2VcbiAgICBmb3IgKHZhciBweD0tdzsgcHg8dzsgKytweClcbiAgICAgIHNwYWNlWyhmbG9vcih5KS1oKSAqIHN3ICsgKGZsb29yKHgpK3B4KV0gPSAwLFxuICAgICAgc3BhY2VbKGZsb29yKHkpK2gpICogc3cgKyAoZmxvb3IoeCkrcHgpXSA9IDA7XG4gICAgZm9yICh2YXIgcHk9LWg7IHB5PGg7ICsrcHkpXG4gICAgICBzcGFjZVsoZmxvb3IoeSkrcHkpICogc3cgKyAoZmxvb3IoeCktdyldID0gMCxcbiAgICAgIHNwYWNlWyhmbG9vcih5KStweSkgKiBzdyArIChmbG9vcih4KSt3KV0gPSAwO1xuXG4gICAgLy8gSW50ZWdyYXRlIHBvc2l0aW9uXG4gICAgdmFyIGNvbGxpc2lvbnMgPSB7fTtcbiAgICBmb3IgKHZhciBrPTA7IGs8PTE7ICsrayl7XG4gICAgICBmb3IgKHZhciB0PTAsIHRzPU1hdGguYWJzKChrP3Z4OnZ5KSpkdCk7IHQ8dHM7ICsrdCl7XG4gICAgICAgIHZhciBzcGQgPSBNYXRoLm1pbih0cyAtIHQsIDEpICogTWF0aC5zaWduKGs/dng6dnkpO1xuICAgICAgICBpZiAoaykgeCArPSBzcGQ7XG4gICAgICAgIGVsc2UgICB5ICs9IHNwZDtcbiAgICAgICAgZm9yICh2YXIgbT0wOyBtPD0xOyArK20pe1xuICAgICAgICAgIGZvciAodmFyIHA9KG0/LXc6LWgpOyBwPChtP3c6aCk7ICsrcCl7XG4gICAgICAgICAgICBpZiAoIHNwYWNlWyhmbG9vcih5KSsobT8taDpwKSkqc3cgKyAoZmxvb3IoeCkrKG0/cDotdykpXVxuICAgICAgICAgICAgICB8fCBzcGFjZVsoZmxvb3IoeSkrKG0/IGg6cCkpKnN3ICsgKGZsb29yKHgpKyhtP3A6IHcpKV0pe1xuICAgICAgICAgICAgICBjb2xsaXNpb25zW3NwYWNlWyhmbG9vcih5KSsobT8taDpwKSkqc3cgKyAoZmxvb3IoeCkrKG0/cDotdykpXV0gPSB0cnVlO1xuICAgICAgICAgICAgICBjb2xsaXNpb25zW3NwYWNlWyhmbG9vcih5KSsobT8gaDpwKSkqc3cgKyAoZmxvb3IoeCkrKG0/cDogdykpXV0gPSB0cnVlO1xuICAgICAgICAgICAgICBpZiAoaykgeCAtPSBzcGQsIHZ4ID0gMDtcbiAgICAgICAgICAgICAgZWxzZSAgIHkgLT0gc3BkLCB2eSA9IDA7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH07XG4gICAgICAgIH07XG4gICAgICB9O1xuICAgIH07XG5cbiAgICAvLyBBZGQgdG8gc3BhY2VcbiAgICBmb3IgKHZhciBweD0tdzsgcHg8dzsgKytweClcbiAgICAgIHNwYWNlWyhmbG9vcih5KS1oKSAqIHN3ICsgKGZsb29yKHgpK3B4KV0gPSBpZCxcbiAgICAgIHNwYWNlWyhmbG9vcih5KStoKSAqIHN3ICsgKGZsb29yKHgpK3B4KV0gPSBpZDtcbiAgICBmb3IgKHZhciBweT0taDsgcHk8aDsgKytweSlcbiAgICAgIHNwYWNlWyhmbG9vcih5KStweSkgKiBzdyArIChmbG9vcih4KS13KV0gPSBpZCxcbiAgICAgIHNwYWNlWyhmbG9vcih5KStweSkgKiBzdyArIChmbG9vcih4KSt3KV0gPSBpZDtcblxuICAgIC8vIFNhdmVcbiAgICBib3gucG9zLnggPSB4O1xuICAgIGJveC5wb3MueSA9IHk7XG4gICAgYm94LnZlbC54ID0gdng7XG4gICAgYm94LnZlbC55ID0gdnk7XG5cbiAgICAvLyBSZXR1cm5zIGNvbGxpc2lvbnNcbiAgICBkZWxldGUgY29sbGlzaW9uc1swXTtcbiAgICByZXR1cm4gY29sbGlzaW9ucztcbiAgfTtcblxuICBmdW5jdGlvbiBkZXN0cm95KGJveCwgc3BhY2UsIHNwYWNlV2lkdGgsIHNwYWNlSGVpZ2h0KXtcbiAgICB2YXIgdyAgPSBib3guZGltLngsIGggID0gYm94LmRpbS55O1xuICAgIHZhciB4ICA9IGJveC5wb3MueCwgeSAgPSBib3gucG9zLnk7XG4gICAgdmFyIHZ4ID0gYm94LnZlbC54LCB2eSA9IGJveC52ZWwueTtcbiAgICB2YXIgc3cgPSBzcGFjZVdpZHRoO1xuICAgIC8vIFJlbW92ZSBmcm9tIHNwYWNlXG4gICAgZm9yICh2YXIgcHg9LXc7IHB4PHc7ICsrcHgpXG4gICAgICBzcGFjZVsoZmxvb3IoeSktaCkgKiBzdyArIChmbG9vcih4KStweCldID0gMCxcbiAgICAgIHNwYWNlWyhmbG9vcih5KStoKSAqIHN3ICsgKGZsb29yKHgpK3B4KV0gPSAwO1xuICAgIGZvciAodmFyIHB5PS1oOyBweTxoOyArK3B5KVxuICAgICAgc3BhY2VbKGZsb29yKHkpK3B5KSAqIHN3ICsgKGZsb29yKHgpLXcpXSA9IDAsXG4gICAgICBzcGFjZVsoZmxvb3IoeSkrcHkpICogc3cgKyAoZmxvb3IoeCkrdyldID0gMDtcbiAgfTtcblxuXG4gIC8vICpIaXRib3gsIEhpdGJveCAtPiBIaXRib3hcbiAgLy9mdW5jdGlvbiBzbGlkZShhLCBiKXtcbiAgICAvL3ZhciBheCA9IGEucG9zLngsIGF5ID0gYS5wb3MueSwgYXcgPSBhLmRpbS54LCBhaCA9IGEuZGltLnk7XG4gICAgLy92YXIgYnggPSBiLnBvcy54LCBieSA9IGIucG9zLnksIGJ3ID0gYi5kaW0ueCwgYmggPSBiLmRpbS55O1xuICAgIC8vdmFyIGF2eCA9IGEudmVsLngsIGF2eSA9IGEudmVsLnk7XG4gICAgLy92YXIgYXhpID0gYXggLSBhdyowLjUsIGF4ZiA9IGF4ICsgYXcqMC41O1xuICAgIC8vdmFyIGF5aSA9IGF5IC0gYWgqMC41LCBheWYgPSBheSArIGFoKjAuNTtcbiAgICAvL3ZhciBieGkgPSBieCAtIGJ3KjAuNSwgYnhmID0gYnggKyBidyowLjU7XG4gICAgLy92YXIgYnlpID0gYnkgLSBiaCowLjUsIGJ5ZiA9IGJ5ICsgYmgqMC41O1xuICAgIC8vdmFyIGR4ID0gYWJzKGJ4IC0gYXgpIC0gKGF3KjAuNSArIGJ3KjAuNSk7XG4gICAgLy92YXIgZHkgPSBhYnMoYnkgLSBheSkgLSAoYWgqMC41ICsgYmgqMC41KTtcblxuICAgIC8vY29uc29sZS5sb2coXCJhOlwiLCBheCwgYXksIGF3LCBhaCk7XG4gICAgLy9jb25zb2xlLmxvZyhcImI6XCIsIGJ4LCBieSwgYncsIGJoKTtcbiAgICAvL2NvbnNvbGUubG9nKFwiYXY6XCIsIGF2eCwgYXZ5KTtcbiAgICAvL2NvbnNvbGUubG9nKFwiYXhyOlwiLGF4aSwgYXhmLCBcImF5cjpcIixheWksIGF5Zik7XG4gICAgLy9jb25zb2xlLmxvZyhcImJ4cjpcIixieGksIGJ4ZiwgXCJieXI6XCIsYnlpLCBieWYpO1xuICAgIC8vY29uc29sZS5sb2coXCJkOlwiLGR4LGR5KTtcblxuICAgIC8vaWYgKGJ4ID49IDAgfHwgZHkgPj0gMClcbiAgICAgIC8vcmV0dXJuIGE7XG5cbiAgICAvL2lmIChkeCA+IGR5KSB7XG4gICAgICAvL2lmIChieGkgPCBheGkgJiYgYXhpIDwgYnhmICYmIGF2eCA8PSAwKSB7XG4gICAgICAgIC8vYS5wb3MueCArPSBieGYgLSBheGk7XG4gICAgICAgIC8vYS52ZWwueCA9IDA7XG4gICAgICAvL31cbiAgICAgIC8vaWYgKGJ4aSA8IGF4ZiAmJiBheGYgPCBieGYgJiYgYXZ4ID49IDApIHtcbiAgICAgICAgLy9hLnBvcy54ICs9IGJ4aSAtIGF4ZjtcbiAgICAgICAgLy9hLnZlbC54ID0gMDtcbiAgICAgIC8vfVxuICAgIC8vfSBlbHNlICB7XG4gICAgICAvL2lmIChieWkgPCBheWkgJiYgYXlpIDwgYnlmICYmIGF2eSA8PSAwKXtcbiAgICAgICAgLy9hLnBvcy55IC09IGR5O1xuICAgICAgICAvL2EudmVsLnkgPSAwO1xuICAgICAgLy99XG4gICAgICAvL2lmIChieWkgPCBheWkgJiYgYXlpIDwgYnlmICYmIGF2eSA+PSAwKXtcbiAgICAgICAgLy9hLnBvcy55ICs9IGR5O1xuICAgICAgICAvL2EudmVsLnkgPSAwO1xuICAgICAgLy99XG4gICAgLy99O1xuXG4gICAgLy9yZXR1cm4gYTtcbiAgLy99O1xuXG4gIHJldHVybiB7XG4gICAgSGl0Ym94OiBIaXRib3gsXG4gICAgZHJhd2VyOiBkcmF3ZXIsXG4gICAgZGVzdHJveTogZGVzdHJveSxcbiAgICB0aWNrOiB0aWNrfTtcbn0pKCk7XG4iLCJtb2R1bGUuZXhwb3J0cyA9IChmdW5jdGlvbigpe1xuICB2YXIgZG93biA9IFtdLCBsYXN0ID0gW10sIHByZXNzZWQgPSBbXSwgcmVsZWFzZWQgPSBbXTtcbiAgZm9yICh2YXIgaT0wOyBpPDI1NTsgKytpKXtcbiAgICB2YXIgayA9IFN0cmluZy5mcm9tQ2hhckNvZGUoaSk7XG4gICAgZG93bltrXSA9IGxhc3Rba10gPSBwcmVzc2VkW2tdID0gcmVsZWFzZWRba10gPSAwO1xuICB9O1xuICBkb2N1bWVudC5vbmtleXByZXNzID0gZnVuY3Rpb24oZSl7XG4gICAgZG93bltTdHJpbmcuZnJvbUNoYXJDb2RlKGUua2V5Q29kZSkudG9Mb3dlckNhc2UoKV0gPSAxO1xuICB9O1xuICBkb2N1bWVudC5vbmtleXVwID0gZnVuY3Rpb24oZSl7XG4gICAgZG93bltTdHJpbmcuZnJvbUNoYXJDb2RlKGUua2V5Q29kZSkudG9Mb3dlckNhc2UoKV0gPSAwO1xuICB9O1xuICBmdW5jdGlvbiB0aWNrKCl7XG4gICAgZm9yICh2YXIgaT0wOyBpPDI1NTsgKytpKXtcbiAgICAgIHZhciBrID0gU3RyaW5nLmZyb21DaGFyQ29kZShpKTtcbiAgICAgIHByZXNzZWRba10gID0gIWxhc3Rba10gJiYgIGRvd25ba107XG4gICAgICByZWxlYXNlZFtrXSA9ICBsYXN0W2tdICYmICFkb3duW2tdO1xuICAgICAgbGFzdFtrXSAgICAgPSBkb3duW2tdO1xuICAgIH07XG4gIH07XG4gIHJldHVybiB7ZG93bjogZG93biwgcHJlc3NlZDogcHJlc3NlZCwgcmVsZWFzZWQ6IHJlbGVhc2VkLCB0aWNrOiB0aWNrfTtcbn0pO1xuIiwibW9kdWxlLmV4cG9ydHMgPSAoZnVuY3Rpb24oKXtcbiAgLy8gVWludCwgVWludCAtPiBTY3JlZW5cbiAgZnVuY3Rpb24gU2NyZWVuKHdpZHRoLCBoZWlnaHQpe1xuICAgIHZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoO1xuICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgdmFyIGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuICAgIHZhciBpbWFnZURhdGEgPSBjb250ZXh0LmdldEltYWdlRGF0YSgwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB2YXIgY29sb3JCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIod2lkdGgqaGVpZ2h0KjQpO1xuICAgIHZhciBjb2xvckJ1ZmZlcjggPSBuZXcgVWludDhDbGFtcGVkQXJyYXkoY29sb3JCdWZmZXIpO1xuICAgIHZhciBjb2xvckJ1ZmZlcjMyID0gbmV3IFVpbnQzMkFycmF5KGNvbG9yQnVmZmVyKTtcbiAgICB2YXIgZGVwdGhCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIod2lkdGgqaGVpZ2h0KjIpO1xuICAgIHZhciBkZXB0aEJ1ZmZlcjE2ID0gbmV3IFVpbnQxNkFycmF5KGRlcHRoQnVmZmVyKTtcbiAgICByZXR1cm4ge1xuICAgICAgY2FudmFzOiBjYW52YXMsXG4gICAgICBjb250ZXh0OiBjb250ZXh0LFxuICAgICAgd2lkdGg6IHdpZHRoLFxuICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICBpbWFnZURhdGE6IGltYWdlRGF0YSxcbiAgICAgIGNvbG9yQnVmZmVyODogY29sb3JCdWZmZXI4LFxuICAgICAgY29sb3JCdWZmZXIzMjogY29sb3JCdWZmZXIzMixcbiAgICAgIGRlcHRoQnVmZmVyMTY6IGRlcHRoQnVmZmVyMTZ9O1xuICB9O1xuXG4gIC8vIFVpbnQzMkFycmF5LCAqU2NyZWVuIC0+IFNjcmVlblxuICBmdW5jdGlvbiBkcmF3QnVmZmVyKGJ1ZmZlcjgsIHNjcmVlbil7XG4gICAgc2NyZWVuLmltYWdlRGF0YS5kYXRhLnNldChidWZmZXI4KTtcbiAgICBzY3JlZW4uY29udGV4dC5wdXRJbWFnZURhdGEoc2NyZWVuLmltYWdlRGF0YSwgMCwgMCk7XG4gIH07XG5cbiAgLy8gWyhOdW1iZXIsIE51bWJlciwgKlVpbnQzMkFycmF5IC0+IFVpbnQzMkFycmF5KV0gLT4gKlNjcmVlbiAtPiBTY3JlZW5cbiAgZnVuY3Rpb24gZHJhd0RyYXdlcnMoZHJhd2Vycywgc2NyZWVuKXtcbiAgICB2YXIgY29sb3JCdWZmZXIzMiA9IHNjcmVlbi5jb2xvckJ1ZmZlcjMyO1xuICAgIGZvciAodmFyIGk9MCwgbD1kcmF3ZXJzLmxlbmd0aDsgaTxsOyArK2kpXG4gICAgICBjb2xvckJ1ZmZlcjMyID0gZHJhd2Vyc1tpXShzY3JlZW4ud2lkdGgsIHNjcmVlbi5oZWlnaHQsIGNvbG9yQnVmZmVyMzIpO1xuICAgIHNjcmVlbi5pbWFnZURhdGEuZGF0YS5zZXQoc2NyZWVuLmNvbG9yQnVmZmVyOCk7XG4gICAgc2NyZWVuLmNvbnRleHQucHV0SW1hZ2VEYXRhKHNjcmVlbi5pbWFnZURhdGEsIDAsIDApO1xuICAgIHJldHVybiBzY3JlZW47XG4gIH07XG5cbiAgLy8gKFVpbnQsIFVpbnQgLT4gUkdCQTgpLCAqU2NyZWVuIC0+IFNjcmVlblxuICBmdW5jdGlvbiBkcmF3KGZpZWxkLCBzY3JlZW4pe1xuICAgIHZhciBjb2xvckJ1ZmZlcjMyID0gc2NyZWVuLmNvbG9yQnVmZmVyMzI7XG4gICAgdmFyIHdpZHRoID0gc2NyZWVuLndpZHRoO1xuICAgIHZhciBoZWlnaHQgPSBzY3JlZW4uaGVpZ2h0O1xuICAgIGZvciAodmFyIHk9MDsgeTxoZWlnaHQ7ICsreSlcbiAgICAgIGZvciAodmFyIHg9MDsgeDx3aWR0aDsgKyt4KVxuICAgICAgICBjb2xvckJ1ZmZlcjMyW3kqd2lkdGgreF0gPSBmaWVsZCh4LCB5KTtcbiAgICBzY3JlZW4uaW1hZ2VEYXRhLmRhdGEuc2V0KHNjcmVlbi5jb2xvckJ1ZmZlcjgpO1xuICAgIHNjcmVlbi5jb250ZXh0LnB1dEltYWdlRGF0YShzY3JlZW4uaW1hZ2VEYXRhLCAwLCAwKTtcbiAgICByZXR1cm4gc2NyZWVuO1xuICB9O1xuXG4gIGZ1bmN0aW9uIGRyYXdJbWFnZSh4LCB5LCBpbWFnZSwgc2NyZWVuKXtcbiAgICBzY3JlZW4uY29udGV4dC5kcmF3SW1hZ2UoaW1hZ2UsIHgsIHkpO1xuICB9O1xuXG4gIC8vICpTY3JlZW4gLT4gU2NyZWVuXG4gIGZ1bmN0aW9uIGNsZWFyKHNjcmVlbiwgY29sKXtcbiAgICBzY3JlZW4uY29sb3JCdWZmZXIzMi5maWxsKGNvbCk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBTY3JlZW46IFNjcmVlbixcbiAgICBkcmF3QnVmZmVyOiBkcmF3QnVmZmVyLFxuICAgIGRyYXdEcmF3ZXJzOiBkcmF3RHJhd2VycyxcbiAgICBkcmF3SW1hZ2U6IGRyYXdJbWFnZSxcbiAgICBkcmF3OiBkcmF3LFxuICAgIGNsZWFyOiBjbGVhcn07XG59KSgpO1xuXG4iLCJtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKXtcbiAgdmFyIHNwcml0ZXMgPSB7XG4gICAgXCJ3YWxsXCI6IHtzaXplOiAxLCBpbWFnZXM6W119LFxuICAgIFwibWFpbl9zdGFuZGluZ1wiOiB7c2l6ZTogMiwgaW1hZ2VzOltdfX07XG4gIHZhciBsb2FkZWQgPSAwO1xuICB2YXIgdG90YWwgPSAwO1xuICBmb3IgKHZhciBrZXkgaW4gc3ByaXRlcyl7XG4gICAgKGZ1bmN0aW9uIChrZXkpe1xuICAgICAgY29uc29sZS5sb2coXCJsb2FkaW5nIHNwcml0ZSBcIitrZXkpO1xuICAgICAgZm9yICh2YXIgaT0wOyBpPHNwcml0ZXNba2V5XS5zaXplOyArK2kpe1xuICAgICAgICAoZnVuY3Rpb24oaSl7XG4gICAgICAgICAgKyt0b3RhbDtcbiAgICAgICAgICB2YXIgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgICBpbWFnZS5zcmMgPSBcImltZy9cIitrZXkrXCIvc3ByaXRlX1wiK2krXCIucG5nXCI7XG4gICAgICAgICAgaW1hZ2Uub25sb2FkID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibG9hZGVkIFwiKyhsb2FkZWQrMSkrXCIvXCIrdG90YWwpO1xuICAgICAgICAgICAgc3ByaXRlc1trZXldLmltYWdlc1tpXSA9IGltYWdlO1xuICAgICAgICAgICAgaWYgKCsrbG9hZGVkID09PSB0b3RhbClcbiAgICAgICAgICAgICAgY2FsbGJhY2soc3ByaXRlcyk7XG4gICAgICAgICAgfTtcbiAgICAgICAgfSkoaSk7XG4gICAgICB9O1xuICAgIH0pKGtleSk7XG4gIH07XG59O1xuXG5cbiIsIm1vZHVsZS5leHBvcnRzID0gW1xuICBbXCIuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlwiLFxuICAgXCIuWFhYLlhYLi5YWFguWFguLi4uLi4uLi4uLi4uLi4uLlwiLFxuICAgXCIuWC5YLlguWC5YLlguWC4uLi4uLi4uLi4uLi4uLi4uLlwiLFxuICAgXCIuWFhYLlhYLi5YLlguWFguLi4uLi4uLi4uLi4uLi4uLlwiLFxuICAgXCIuWC4uLlguWC5YLlguWC4uLi4uLi4uLi4uLi4uLi4uLlwiLFxuICAgXCIuWC4uLlguWC5YWFguWC4uLi4uLi4uLi4uLi4uLi4uLlwiLFxuICAgXCIuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlwiLFxuICAgXCJYLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5EWFhYWFwiLFxuICAgXCJYLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5EWFhYWFwiLFxuICAgXCJYLkguLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5EWFhYWFwiLFxuICAgXCJYLi4uLi4uLi4uLlhYWFhYWC4uLi4uLi4uLi5EWFhYWFwiLFxuICAgXCJYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFwiXSxcbiAgW1wiLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cIixcbiAgIFwiLlhYWC5YWC4uWFhYLlhYLi4uLi4uLi4uLi4uLi4uLi5cIixcbiAgIFwiLlguWC5YLlguWC5YLlguLi4uLi4uLi4uLi4uLi4uLi5cIixcbiAgIFwiLlhYWC5YWC4uWC5YLlhYLi4uLi4uLi4uLi4uLi4uLi5cIixcbiAgIFwiLlguLi5YLlguWC5YLlguLi4uLi4uLi4uLi4uLi4uLi5cIixcbiAgIFwiLlguLi5YLlguWFhYLlguLi4uLi4uLi4uLi4uLi4uLi5cIixcbiAgIFwiLi4uLi4uLi4uLi4uLi4uSy4uLi4uLi4uLi4uLi4uLi5cIixcbiAgIFwiWC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uRFhYWFhcIixcbiAgIFwiWC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uRFhYWFhcIixcbiAgIFwiWC5ILi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uRFhYWFhcIixcbiAgIFwiWC4uLi4uLi4uLi5YWFhYWFguLi4uLi4uLi4uRFhYWFhcIixcbiAgIFwiWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhcIl1dO1xuIiwibW9kdWxlLmV4cG9ydHMgPSAoZnVuY3Rpb24oKXtcbiAgLy8gTnVtYmVyLCBOdW1iZXIgLT4gVjJcbiAgZnVuY3Rpb24gVmVjdG9yMih4LCB5KXtcbiAgICByZXR1cm4ge3g6IHgsIHk6IHl9O1xuICB9XG4gIFxuICAvLyBWMiwgVjIgLT4gTnVtYmVyXG4gIGZ1bmN0aW9uIGFuZ2xlKGEsIGIpe1xuICAgIHZhciBhbmcgPSAoTWF0aC5hdGFuMihiLnksIGIueCkgLSBNYXRoLmF0YW4yKGEueSwgYS54KSArIE1hdGguUEkqMikgJSAoTWF0aC5QSSoyKTtcbiAgICBpZiAoYW5nID4gTWF0aC5QSSkgYW5nIC09IE1hdGguUEkqMjtcbiAgICByZXR1cm4gYW5nO1xuICB9O1xuXG4gIC8vIFYyIC0+IE51bWJlclxuICBmdW5jdGlvbiBsZW4oYSl7XG4gICAgcmV0dXJuIE1hdGguc3FydChhLngqYS54ICsgYS55KmEueSk7XG4gIH07XG5cbiAgLy8gVjIsIE51bWJlciAtPiBWMlxuICBmdW5jdGlvbiBzY2FsZShhLCBzKXtcbiAgICByZXR1cm4gVmVjdG9yMihhLnggKiBzLCBhLnkgKiBzKTtcbiAgfTtcblxuICAvLyBWMiAtPiBOdW1iZXJcbiAgZnVuY3Rpb24gbm9ybWFsaXplKGEpe1xuICAgIHJldHVybiBzY2FsZShhLCAxL2xlbihhKSk7IFxuICB9O1xuXG4gIC8vIFYyLCBOdW1iZXIgLT4gVjJcbiAgZnVuY3Rpb24gcm90YXRlKGEsIGFuZyl7XG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IGEueCAqIE1hdGguY29zKGFuZykgLSBhLnkgKiBNYXRoLnNpbihhbmcpLFxuICAgICAgeTogYS54ICogTWF0aC5zaW4oYW5nKSArIGEueSAqIE1hdGguY29zKGFuZyl9O1xuICB9O1xuXG4gIC8vIFYyLCBWMiAtPiBWMlxuICBmdW5jdGlvbiBzdWIoYSwgYil7XG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IGEueCAtIGIueCxcbiAgICAgIHk6IGEueSAtIGIueX07XG4gIH07XG5cbiAgLy8gVjIsIFYyIC0+IFYyXG4gIGZ1bmN0aW9uIGFkZChhLCBiKXtcbiAgICByZXR1cm4ge1xuICAgICAgeDogYS54ICsgYi54LFxuICAgICAgeTogYS55ICsgYi55fTtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIFZlY3RvcjI6IFZlY3RvcjIsXG4gICAgcm90YXRlOiByb3RhdGUsXG4gICAgYW5nbGU6IGFuZ2xlLFxuICAgIGFkZDogYWRkLFxuICAgIHN1Yjogc3ViLFxuICAgIGxlbjogbGVuLFxuICAgIHNjYWxlOiBzY2FsZSxcbiAgICBub3JtYWxpemU6IG5vcm1hbGl6ZX07XG59KSgpO1xuIiwiLy92YXIgSW1hZ2UgPSByZXF1aXJlKFwiLi8uLi8uLi9EYXR0YXRhL0ltYWdlLmpzXCIpO1xudmFyIFNjcmVlbiA9IHJlcXVpcmUoXCIuL1NjcmVlbi5qc1wiKTtcbnZhciBTcHJpdGVzID0gcmVxdWlyZShcIi4vU3ByaXRlcy5qc1wiKTtcbnZhciBIaXRib3ggPSByZXF1aXJlKFwiLi9IaXRib3guanNcIik7XG52YXIgRHJhd2VycyA9IHJlcXVpcmUoXCIuL0RyYXdlcnMuanNcIik7XG52YXIgVmVjdG9yMiA9IHJlcXVpcmUoXCIuL1ZlY3RvcjIuanNcIik7XG52YXIgc3RhZ2VzID0gcmVxdWlyZShcIi4vU3RhZ2VzLmpzXCIpO1xudmFyIEtleSA9IHJlcXVpcmUoXCIuL0tleWJvYXJkU3RhdGUuanNcIikoKTtcbnZhciBWMiA9IFZlY3RvcjIuVmVjdG9yMjtcbnZhciBmbG9vciA9IE1hdGguZmxvb3I7XG52YXIgc3FydCA9IE1hdGguc3FydDtcbnZhciBGUFMgPSA2MDtcbnZhciBzcHJpdGVzO1xudmFyIHNjcmVlbiA9IFNjcmVlbi5TY3JlZW4od2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCk7XG52YXIgZ2FtZU9iamVjdHM7XG52YXIgZ2FtZU9iamVjdEJ5SWQ7XG52YXIgaGVybztcbnZhciBnYW1lO1xudmFyIGxldmVsO1xudmFyIHNwYWNlO1xudmFyIHNwYWNlV2lkdGg7XG52YXIgc3BhY2VIZWlnaHQ7XG5cbnZhciBOZW8gPSAoZnVuY3Rpb24oKXtcbiAgdmFyIG5leHRJZCA9IDA7XG4gIHJldHVybiBmdW5jdGlvbih3LCBoLCB4LCB5LCBmYWxsKXtcbiAgICB2YXIgaWQgPSArK25leHRJZDtcbiAgICB2YXIgb2JqID0ge1xuICAgICAgaWQ6IGlkLFxuICAgICAgcmVuZGVyOiBmdW5jdGlvbihzY3JlZW4pe30sXG4gICAgICB0aWNrOiBmdW5jdGlvbihkdCl7fSxcbiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCl7XG4gICAgICAgIEhpdGJveC5kZXN0cm95KG9iai5oaXRib3gsIHNwYWNlLCBzcGFjZVdpZHRoLCBzcGFjZUhlaWdodCk7XG4gICAgICAgIGRlbGV0ZSBnYW1lT2JqZWN0QnlJZFtvYmouaWRdO1xuICAgICAgICBnYW1lT2JqZWN0cyA9IGdhbWVPYmplY3RzLmZpbHRlcihmdW5jdGlvbihvYmpfKXtcbiAgICAgICAgICByZXR1cm4gb2JqXy5pZCAhPT0gb2JqLmlkO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBoaXRib3g6IEhpdGJveC5IaXRib3goaWQsIFYyKHcsIGgpLCBWMih4LCB5KSwgVjIoMCwgMCksIGZhbGwpfTtcbiAgICBnYW1lT2JqZWN0cy5wdXNoKG9iaik7XG4gICAgZ2FtZU9iamVjdEJ5SWRbb2JqLmlkXSA9IG9iajtcbiAgICByZXR1cm4gb2JqO1xuICB9O1xufSkoKTtcblxudmFyIGludHJvID0gSW50cm8oKTtcbnZhciBtZW51ID0gTWVudSgpO1xudmFyIHJ1bm5pbmdBcHAgPSBpbnRybztcblxuZnVuY3Rpb24gaW50ZXJhY3Rfd2l0aF9odW1hbihraWxsX2h1bWFucywgYmVfbmljZV90b19odW1hbnMpe1xuICB2YXIgaXNfY3JhenlfbXVyZGVyaW5nX3JvYm90ID0gZmFsc2U7XG4gIGlmIChpc19jcmF6eV9tdXJkZXJpbmdfcm9ib3QgPSB0cnVlKVxuICAgIGtpbGxfaHVtYW5zKCk7XG4gIGVsc2VcbiAgICBiZV9uaWNlX3RvX2h1bWFucygpO1xufTtcblxuZnVuY3Rpb24gSW50cm8oKXtcbiAgdmFyIHNlbGVjdGVkID0gMDtcbiAgdmFyIG9wdGlvbnMgPSBbMCwgMSwgMl07XG4gIHZhciBwcmV2ID0ge307XG4gIGZ1bmN0aW9uIHRpY2soZHQpe1xuICAgIGlmIChLZXkucHJlc3NlZC53KVxuICAgICAgc2VsZWN0ZWQgPSAoc2VsZWN0ZWQgLSAxICsgMykgJSAzO1xuICAgIGlmIChLZXkucHJlc3NlZC5zKVxuICAgICAgc2VsZWN0ZWQgPSAoc2VsZWN0ZWQgKyAxICsgMykgJSAzO1xuICAgIGlmIChLZXkucHJlc3NlZC5qKVxuICAgICAgU3RhcnRMZXZlbCgwKTtcbiAgfTtcbiAgZnVuY3Rpb24gcmVuZGVyKHNjcmVlbil7XG4gICAgU2NyZWVuLmRyYXdEcmF3ZXJzKG9wdGlvbnMubWFwKGZ1bmN0aW9uKGkpe1xuICAgICAgdmFyIGNvbCA9IGkgPT09IHNlbGVjdGVkID8gMHhGRkFBQUFBQSA6IDB4RkZDQ0NDQ0M7XG4gICAgICByZXR1cm4gRHJhd2Vycy5yZWN0YW5nbGUoMzIqNSwgMzIqKDEraSoyKSwgMzIqNCwgMTYsIGNvbCk7XG4gICAgfSksIHNjcmVlbik7XG4gIH07XG4gIHJldHVybiB7dGljazogdGljaywgcmVuZGVyOiByZW5kZXJ9O1xufTtcblxuZnVuY3Rpb24gS2lsbGVyUm9ib3QoeCwgeSl7XG4gIHZhciBvYmogPSBOZW8oMiwgMiwgeCwgeSwgMCk7XG4gIHZhciBjaGFyZ2UgPSAwO1xuICBvYmoudGljayA9IGZ1bmN0aW9uKGR0KXtcbiAgICBjaGFyZ2UgKz0gZHQ7XG4gICAgaWYgKGNoYXJnZSA+IDEpe1xuICAgICAgY2hhcmdlID0gMDtcbiAgICAgIHZhciBkaXIgPSBWZWN0b3IyLnN1YihoZXJvLmhpdGJveC5wb3MsIG9iai5oaXRib3gucG9zKTtcbiAgICAgIExhc2VyKG9iai5oaXRib3gucG9zLngsIG9iai5oaXRib3gucG9zLnksIGRpci54LCBkaXIueSk7XG4gICAgfTtcbiAgfTtcbiAgb2JqLmRyYXcgPSBmdW5jdGlvbih4LCB5KXtcbiAgICBzY3JlZW4uY29udGV4dC5kcmF3SW1hZ2Uoc3ByaXRlcy5tYWluX3N0YW5kaW5nLmltYWdlc1swXSwgeCwgeSk7XG4gIH07XG4gIHJldHVybiBvYmo7XG59O1xuXG5mdW5jdGlvbiBMYXNlcih4LCB5LCBkeCwgZHkpe1xuICB2YXIgZCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTtcbiAgdmFyIG9iaiA9IE5lbygzLCAzLCB4K2R4L2QqMTYsIHksIDApO1xuICBvYmoudHlwZSA9IFwiTGFzZXJcIjtcbiAgb2JqLmhpdGJveC52ZWwueCA9IGR4L2QqNTAwO1xuICBvYmouaGl0Ym94LnZlbC55ID0gZHkvZCo1MDA7XG4gIG9iai5kcmF3ID0gZnVuY3Rpb24oeCwgeSl7XG4gICAgc2NyZWVuLmNvbnRleHQuZHJhd0ltYWdlKHNwcml0ZXMubWFpbl9zdGFuZGluZy5pbWFnZXNbMF0sIHgsIHkpO1xuICAgIC8vcmV0dXJuIERyYXdlcnMucmVjdGFuZ2xlKHgsIHksIG9iai5oaXRib3guZGltLngsIG9iai5oaXRib3guZGltLnksIDB4RkZGRkFBQUEpO1xuICB9O1xuICBvYmoub25Db2xsaWRlID0gZnVuY3Rpb24ob3RoZXIpe1xuICAgIG9iai5kZXN0cm95KCk7XG4gICAgaWYgKG90aGVyLnR5cGUgPT09IFwiSGVyb1wiKVxuICAgICAgU3RhcnRMZXZlbChsZXZlbCk7XG4gICAgICBcbiAgfTtcbn07XG5cbmZ1bmN0aW9uIEhlcm8oeCwgeSl7XG4gIHZhciBvYmogPSBOZW8oMTYsIDE2LCB4LCB5LCA0MDApO1xuICB2YXIgY2FuSnVtcCA9IDE7XG4gIG9iai50eXBlID0gXCJIZXJvXCI7XG4gIG9iai50aWNrID0gZnVuY3Rpb24oZHQpe1xuICAgIHZhciBwYWQgPSBWMihLZXkuZG93bi5kIC0gS2V5LmRvd24uYSwgS2V5LmRvd24ucyAtIEtleS5kb3duLncpO1xuICAgIG9iai5oaXRib3gudmVsLnggPSBwYWQueCAqIDE0MDtcbiAgICBpZiAoY2FuSnVtcCAmJiBLZXkucHJlc3NlZC5qKXtcbiAgICAgIG9iai5oaXRib3gudmVsLnkgPSAtMjIwO1xuICAgICAgY2FuSnVtcCA9IDA7XG4gICAgfTtcbiAgfTtcbiAgb2JqLmRyYXcgPSBmdW5jdGlvbih4LCB5KXtcbiAgICB2YXIgaSA9IE1hdGguZmxvb3IoKChEYXRlLm5vdygpLzEwMDApKjQpJTIpO1xuICAgIHNjcmVlbi5jb250ZXh0LmRyYXdJbWFnZShzcHJpdGVzLm1haW5fc3RhbmRpbmcuaW1hZ2VzW2ldLCB4LCB5KTtcbiAgfTtcbiAgb2JqLm9uQ29sbGlkZSA9IGZ1bmN0aW9uKG9iail7XG4gICAgaWYgKCFvYmopIHJldHVybjsgLy8gVE9ETzogRklYTUVcbiAgICBpZiAob2JqLnR5cGUgPT09IFwiV2FsbFwiKVxuICAgICAgY2FuSnVtcCA9IDE7XG4gICAgaWYgKG9iai50eXBlID09PSBcIkRvb3JcIilcbiAgICAgIFN0YXJ0TGV2ZWwobGV2ZWwgKyAxKTtcbiAgfTtcbiAgcmV0dXJuIG9iajtcbn07XG5cbmZ1bmN0aW9uIFdhbGwoeCx5KXtcbiAgdmFyIG9iaiA9IE5lbygxNiwxNiwgeCx5LCAwKTtcbiAgZnVuY3Rpb24gdGljaygpe307XG4gIGZ1bmN0aW9uIGRyYXcoeCwgeSl7XG4gICAgc2NyZWVuLmNvbnRleHQuZHJhd0ltYWdlKHNwcml0ZXMud2FsbC5pbWFnZXNbMF0sIHgsIHkpO1xuICAgIC8vcmV0dXJuIERyYXdlcnMucmVjdGFuZ2xlKHgsIHksIG9iai5oaXRib3guZGltLngsIG9iai5oaXRib3guZGltLnksIDB4RkZBQUFBQUEpO1xuICB9O1xuICBvYmoudHlwZSA9IFwiV2FsbFwiO1xuICBvYmoudGljayA9IHRpY2s7XG4gIG9iai5kcmF3ID0gZHJhdztcbiAgcmV0dXJuIG9iajtcbn07XG5cbmZ1bmN0aW9uIERvb3IoeCx5KXtcbiAgdmFyIG9iaiA9IE5lbygxNiwxNiwgeCx5LCAwKTtcbiAgZnVuY3Rpb24gdGljaygpe307XG4gIGZ1bmN0aW9uIGRyYXcoeCwgeSl7XG4gICAgc2NyZWVuLmNvbnRleHQuZHJhd0ltYWdlKHNwcml0ZXMubWFpbl9zdGFuZGluZy5pbWFnZXNbMF0sIHgsIHkpO1xuICB9O1xuICBvYmoudHlwZSA9IFwiRG9vclwiO1xuICBvYmoudGljayA9IHRpY2s7XG4gIG9iai5kcmF3ID0gZHJhdztcbiAgcmV0dXJuIG9iajtcbiAgXG59O1xuXG5mdW5jdGlvbiBHYW1lKHN0YWdlKXtcbiAgdmFyIGNvdW50ID0gMDtcbiAgZ2FtZU9iamVjdHMgPSBbXTtcbiAgZ2FtZU9iamVjdEJ5SWQgPSB7fTtcbiAgZm9yICh2YXIgaj0wOyBqPHN0YWdlLmxlbmd0aDsgKytqKXtcbiAgICB2YXIgbGluZSA9IHN0YWdlW2pdO1xuICAgIGZvciAodmFyIGk9MDsgaTxsaW5lLmxlbmd0aDsgKytpKXtcbiAgICAgIHN3aXRjaCAobGluZVtpXSl7XG4gICAgICAgIGNhc2UgXCJIXCI6IGhlcm8gPSBIZXJvKGkqMzItMTYsIGoqMzItMTYpOyBicmVhaztcbiAgICAgICAgY2FzZSBcIlhcIjogV2FsbChpKjMyLTE2LCBqKjMyLTE2KTsgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJEXCI6IERvb3IoaSozMi0xNiwgaiozMi0xNik7IGJyZWFrO1xuICAgICAgICBjYXNlIFwiS1wiOiBLaWxsZXJSb2JvdChpKjMyLTE2LCBqKjMyLTE2KTsgYnJlYWs7XG4gICAgICB9XG4gICAgfTtcbiAgfTtcblxuICBmdW5jdGlvbiB0aWNrKGR0KXtcbiAgICBpZiAoS2V5LnByZXNzZWQubSlcbiAgICAgIHJ1bm5pbmdBcHAgPSBtZW51O1xuICAgIGZvciAodmFyIGk9MCwgbD1nYW1lT2JqZWN0cy5sZW5ndGg7IGk8bDsgKytpKXtcbiAgICAgIGdhbWVPYmplY3RzW2ldLnRpY2soZHQpO1xuICAgICAgdmFyIGNvbGxpc2lvbnMgPSBIaXRib3gudGljayhkdCwgc3BhY2UsIHNwYWNlV2lkdGgsIHNwYWNlSGVpZ2h0LCBnYW1lT2JqZWN0c1tpXS5oaXRib3gpO1xuICAgICAgaWYgKGdhbWVPYmplY3RzW2ldLm9uQ29sbGlkZSlcbiAgICAgICAgZm9yICh2YXIgaWQgaW4gY29sbGlzaW9ucyl7XG4gICAgICAgICAgZ2FtZU9iamVjdHNbaV0ub25Db2xsaWRlKGdhbWVPYmplY3RCeUlkW2lkXSk7XG4gICAgICAgICAgaWYgKGdhbWVPYmplY3RCeUlkW2lkXS5vbkNvbGxpZGUpXG4gICAgICAgICAgICBnYW1lT2JqZWN0QnlJZFtpZF0ub25Db2xsaWRlKGdhbWVPYmplY3RCeUlkW2ldKTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgfTtcbiAgfTtcbiAgZnVuY3Rpb24gcmVuZGVyKHNjcmVlbil7XG4gICAgc2NyZWVuLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHNjcmVlbi53aWR0aCwgc2NyZWVuLmhlaWdodCk7XG4gICAgZm9yICh2YXIgaT0wOyBpPGdhbWVPYmplY3RzLmxlbmd0aDsgKytpKXtcbiAgICAgIHZhciBvYmogPSBnYW1lT2JqZWN0c1tpXTtcbiAgICAgIHZhciBwb3MgPSBWZWN0b3IyLmFkZChcbiAgICAgICAgVmVjdG9yMi5zdWIob2JqLmhpdGJveC5wb3MsIGhlcm8uaGl0Ym94LnBvcyksXG4gICAgICAgIFYyKHNjcmVlbi53aWR0aC8yLCBzY3JlZW4uaGVpZ2h0LzIpKTtcbiAgICAgIG9iai5kcmF3KHBvcy54LCBwb3MueSk7XG4gICAgfTtcbiAgfTtcbiAgcmV0dXJuIHt0aWNrOiB0aWNrLCByZW5kZXI6IHJlbmRlcn07XG59O1xuXG5mdW5jdGlvbiBNZW51KCl7XG4gIGZ1bmN0aW9uIHRpY2soZHQpe1xuICAgIGlmIChLZXkucHJlc3NlZC5qKVxuICAgICAgcnVubmluZ0FwcCA9IGdhbWU7XG4gIH07XG4gIGZ1bmN0aW9uIHJlbmRlcihzY3JlZW4pe1xuICAgIFNjcmVlbi5kcmF3RHJhd2VycyhbRHJhd2Vycy5yZWN0YW5nbGUoMzIsIDMyLCA4LCA4LCAweEZGRkZBQUFBKV0sIHNjcmVlbik7XG4gIH07XG4gIHJldHVybiB7dGljazogdGljaywgcmVuZGVyOiByZW5kZXJ9O1xufTtcblxuZnVuY3Rpb24gU3RhcnRMZXZlbChsdil7XG4gIGNvbnNvbGUubG9nKFwiP1wiKTtcbiAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgIHNwYWNlV2lkdGggPSAyMDQ4O1xuICAgIHNwYWNlSGVpZ2h0ID0gMjA0ODtcbiAgICBzcGFjZSA9IG5ldyBVaW50MTZBcnJheShzcGFjZVdpZHRoICogc3BhY2VIZWlnaHQpO1xuICAgIHJ1bm5pbmdBcHAgPSBnYW1lID0gR2FtZShzdGFnZXNbbHYlc3RhZ2VzLmxlbmd0aF0pO1xuICAgIGNvbnNvbGUubG9nKFwiP1wiLCBzdGFnZXNbbHYlc3RhZ2VzLmxlbmd0aF0sIGx2LCBzdGFnZXMubGVuZ3RoKTtcbiAgICBsZXZlbCA9IGx2O1xuICB9LCAxKTtcbn07XG5cbndpbmRvdy5vbmxvYWQgPSBmdW5jdGlvbigpe1xuICBTcHJpdGVzKGZ1bmN0aW9uKHNwcml0ZXNfKXtcbiAgICBzcHJpdGVzID0gc3ByaXRlc187XG4gICAgdmFyIG1haW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm1haW5cIik7XG4gICAgc2NyZWVuLmNhbnZhcy5zdHlsZSA9IFtcbiAgICAgIFwiaW1hZ2UtcmVuZGVyaW5nOiBvcHRpbWl6ZVNwZWVkO1wiLFxuICAgICAgXCJpbWFnZS1yZW5kZXJpbmc6IC1tb3otY3Jpc3AtZWRnZXM7XCIsXG4gICAgICBcImltYWdlLXJlbmRlcmluZzogLXdlYmtpdC1vcHRpbWl6ZS1jb250cmFzdDtcIixcbiAgICAgIFwiaW1hZ2UtcmVuZGVyaW5nOiAtby1jcmlzcC1lZGdlcztcIixcbiAgICAgIFwiaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7XCIsXG4gICAgICBcIi1tcy1pbnRlcnBvbGF0aW9uLW1vZGU6IG5lYXJlc3QtbmVpZ2hib3I7XCJdLmpvaW4oXCJcIik7XG4gICAgbWFpbi5hcHBlbmRDaGlsZChzY3JlZW4uY2FudmFzKTtcbiAgICBzZXRJbnRlcnZhbChmdW5jdGlvbigpe1xuICAgICAgS2V5LnRpY2soKTtcbiAgICAgIHJ1bm5pbmdBcHAudGljaygxL0ZQUyk7XG4gICAgICBTY3JlZW4uY2xlYXIoc2NyZWVuKTtcbiAgICAgIHJ1bm5pbmdBcHAucmVuZGVyKHNjcmVlbik7XG4gICAgfSwgMTAwMC9GUFMpO1xuXG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzcHJpdGVzLm1haW5fc3RhbmRpbmcuaW1hZ2VzWzBdKTtcbiAgfSk7XG59O1xuXG4iXX0=
